---
title: "Assignment 3"
author: "Carmen Hoyt and Karol Paya"
date: "2025-04-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Background

The **total almond yield** equation is the following:

Y = -0.015Tn2 - 0.0046Tn2\^2 - 0.07P1 + 0.0043P1\^2 + 0.28

where: Y: represents the yield anomaly (ton acre\^-2), Tn2: average minimum temperature for February (°C), P1: total precipitation for January (mm).

To convert profits into **real profits** adjusted to the base year, we used the following equation:

Inflation Adjusted Profit (base year) = Nominal Profit~t~ x Inflation Adjustment~t~

Inflation Adjustment = Price Index~base year~ / ((1 + Inflation Rate~1~) x (1 + Inflation Rate~2~) x (1 + Inflation Rate~t~))

US inflation data source: <https://www.macrotrends.net/global-metrics/countries/USA/united-states/inflation-rate-cpi>

**Profit Model Assumptions**

-   Real profits are calculated in 2010 dollars (base year), using cumulative inflation from 1988–2010.

-   Constant Almond Price per Ton: The price of almonds is assumed to be \$5,000 per ton for all years.

-   Inflation rates used are annual averages, taken from U.S. Consumer Price Index (CPI) data.

## Load Libraries

```{r, message=FALSE}
library(readr)
library(janitor)
```

## Load Model and Data

```{r, message=FALSE}
# Load Model
source("almond_yield_anomoly.R")

# Load Data
data <- read_delim("clim.txt", delim = " ", col_names = TRUE, quote = "") %>%
  # Clean column names
  clean_names()
```

## Run Almond Model

```{r, message=FALSE}
# Run Model
almond_yield_anomaly_from_daily(data)

# Save results
almond <- almond_yield_anomaly_from_daily(data)

# View results (in tons/acre)
almond$min_yield_anomaly
almond$mean_yield_anomaly
almond$max_yield_anomaly
```

## Run Profit Model

```{r, message=FALSE}
# Load inflation-adjusted profit function
source("inflation_adjusted_profit.R")

# Run the profit model with inflation adjustment
profit_summary <- inflation_adjusted_profit(
  yield = almond,
  inflation_file = "macrotrends_us_inflation.csv",
  price_per_ton = 5000,
  base_year = 2010,
  year_1 = 1988
)

# View inflation-adjusted profit results
profit_summary$total_inflation_adjusted_profit
profit_summary$min_inflation_adjusted_profit
profit_summary$mean_inflation_adjusted_profit
profit_summary$max_inflation_adjusted_profit

```

## Informal Sensitivity Analysis

Parameter 1: `price_per_ton` is defaulted to $5,000/ton. Let's try +/- 10%.

Parameter 2: `base_year` is defaulted to 2010. Let's try +/- 3 years.

```{r, message=FALSE}

options(scipen=999)

# Parameter 1
deviation <- 0.1 #10%
base_price <- 5000
price_thresh <- runif(
  min = base_price - (deviation * base_price),
  max = base_price + (deviation * base_price),
  n = 40 # samples
)

# Run model for price parameters
profit_summary_price <- price_thresh %>%
  map(~ inflation_adjusted_profit(
  yield = almond,
  inflation_file = "macrotrends_us_inflation.csv",
  price_per_ton = .x,
  base_year = 2010,
  year_1 = 1988
))

# Parameter 2: 
deviation <- 5
base_year <- 2010
sample_years <- sample(
  (base_year - 5):(base_year + 5), 
  size = 40, 
  replace = TRUE)

# Put samples together
parms <- cbind.data.frame(price_per_ton = price_thresh, base_year = sample_years)

results <- parms %>% pmap(inflation_adjusted_profit,
                          yield = almond,
  inflation_file = "macrotrends_us_inflation.csv",
  year_1 = 1988)

results[[1]]

length(results)

# Create a dataframe of results
min_price <- map_df(results, `[`, c("min_inflation_adjusted_profit"))
mean_price <- map_df(results, `[`, c("mean_inflation_adjusted_profit"))
max_price <- map_df(results, `[`, c("max_inflation_adjusted_profit"))

results_df <- data.frame(
  min_price = min_price$min_inflation_adjusted_profit,
  mean_price = mean_price$mean_inflation_adjusted_profit,
  max_price = max_price$max_inflation_adjusted_profit
) %>% cbind(parms) %>%
  pivot_longer(cols = 1:3, values_to = "inflation_adjusted_profit", names_to = "anamoly")

# Plot results
# Base year vs. profits (per anamoly)
ggplot(results_df, aes(as.factor(base_year), inflation_adjusted_profit, group = anamoly, fill = anamoly)) +
  geom_boxplot() +
  labs(y = "Inflation Adjusted Profit",
       x = "Base year",
       fill = "Anamoly Category")

# Price per ton vs. profits (per anamoly)
ggplot(results_df, aes(price_per_ton, inflation_adjusted_profit, group = anamoly, color = anamoly)) +
  geom_line() +
  labs(x = "Price (per ton)",
       y = "Inflation Adjusted Profit",
       color = "Anamoly Category")
```

